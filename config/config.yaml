# ─────────────────────────────────────────────
# config.yaml  •  Master settings for pipeline
# ─────────────────────────────────────────────

# -------------------------------------------------------------------
# 1. Paths & general run-time options
#
# All data and outputs will be stored under a single root folder
# defined by `root_dir`. This allows you to relocate the project
# easily by changing just one path (e.g., "D:/test_me" or "/mnt/project_x").
#
# All other paths are **relative** to `root_dir`, and should NOT be absolute.
# The pipeline code will automatically resolve them using:
#     full_path = Path(root_dir) / relative_path
#
# This design ensures the codebase remains portable and clean.
# -------------------------------------------------------------------

paths:
  dataset_base_path: "D:/dataset/drowsy_driving_raja"
  image_save_path: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/driver_annotation/images_ear"
  ear_data_save_path: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/driver_annotation/ear_data"
  report_path: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/driver_annotation/report_MD.json"
  source_face_bb_path: "../../source_face_bb.json"
  config_video_detail: "../src/utils/config_video_detail.json"
  pyblink_path: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/driver_annotation/pyblinkers"
  pyblink_ear_combine: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/driver_annotation/pyblink_ear_combine"
  mov_sequence_csv_path: "C:/Users/{user_name}/IdeaProjects/driver_annotation/mov_sequence.csv"
  actual_frame_no_path: "C:/Users/{user_name}/IdeaProjects/driver_annotation/driver_annotation/cross_check_frame_number/host_times_data.xlsx"
  pyblink_ear_combine_ground: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/pyblink_ear_combine_ground_annot"
  pyblink_ear_new_annot: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/pyblink_ear_new_annot"
  EC_EC_EAR_th: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/driver_annotation/EC_EC_EAR_output/combined_jsons"
  label_refinement: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/label_refinement"
  best_threshold_cutoff: "G:/My Drive/data set/experiment result pyblink/best_threshold"
  cvat_zip: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/cvat_zip_final"
  cvat_human_label: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/cvat_human_label"
  performance_pyblink: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/performance_pyblink"
  eeg_segmented_annot: "D:/dataset/drowsy_driving_raja_processed"
  ear_segmented_annot: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/ear_segmented_annot"
  cvat_root: "C:/Users/{user_name}/OneDrive - ums.edu.my/CVAT_visual_annotation/cvat_zip_final"
  raw_downsampled: "D:/dataset/drowsy_driving_raja_processed"

subjects: [S1, S2, S3, S4, S5, S6, S7, S10, S11, S12, S13, S16, S17, S18, S19, S20, S21, S22, S23, S24, S26, S27]


raw_preprocessing:
  highpass_hz: 0.5
  lowpass_hz: 30.0
  resample_hz: 100

eeg_cleaning:
  ica:
    l_freq: 1.0
    n_components: 15
    random_state: 97
  epoching:
    duration: 30.0
    overlap: 0
  autoreject:
    n_interpolate: [1, 2, 4]
    random_state: 11

eeg_regions:
  frontal:
    - E1
    - E2
    - E3
    - E8
    - E9
    - E10
    - E14
    - E15
    - E16
    - E17
    - E18
    - E22
    - E23
    - E24
    - E27
    - E28
    - E33

  central:
    - E5
    - E6
    - E7
    - E11
    - E12
    - E19
    - E20
    - E25
    - E26
    - E29
    - E30
    - E36
    - E37
    - E42
    - E43

  temporal_left:
    - E44
    - E45
    - E46
    - E50
    - E51
    - E52
    - E57
    - E58
    - E59
    - E64
    - E65

  temporal_right:
    - E103
    - E104
    - E108
    - E109
    - E114
    - E115
    - E116
    - E120
    - E121
    - E122
    - E125

  parietal:
    - E31
    - E32
    - E38
    - E39
    - E40
    - E41
    - E47
    - E48
    - E53
    - E54
    - E55
    - E56
    - E60
    - E61
    - E62
    - E66
    - E67

  occipital:
    - E66
    - E70
    - E71
    - E75
    - E76
    - E82
    - E83
    - E89
    - E90
    - E95
    - E96

  peripheral:
    - E127
    - E126
    - E125
    - E124
    - E123
    - E117
    - E118
    - E119
    - E120
    - E112
    - E113
    - E114
    - E109
    - E108
    - E99
    - E100
    - E101
    - E102
    - E93
    - E94
    - E95
    - E96
    - E84
    - E85
    - E86
    - E87
    - E72
    - E73
    - E74
    - E63
    - E68
    - E69
    - E57
    - E50
    - E45
    - E38
    - E33

project:
  root_dir:               "D:/dataset/drowsy_driving_raja_processed/data"    # Root directory for all pipeline outputs (data, features, models, etc.)
  raw_data_dir:           "experimentation/raw"                         # Relative to root_dir: original EEG (.fif), EAR (.csv)
  epoch_cache_dir:        "experimentation/epochs"                      # Relative to root_dir: cached MNE Epochs
  features_dir:           "outputs/features"                            # Relative to root_dir: per-epoch features and master Parquet
  reports_dir:            "outputs/reports"                             # Relative to root_dir: final HTML/Notebook reports
  models_dir:             "outputs/models"                              # Relative to root_dir: trained ML models (.joblib)
  plots_dir:              "outputs/plots"                               # Relative to root_dir: correlation plots, evaluation graphs
  logs_dir:               "logs"                                        # Folder for pipeline logs (one log file per run)
  subject_metadata_file:  "experimentation/subject_metadata.csv"        # Relative to root_dir: demographics/metadata for filtering
  log_level:              "INFO"                                        # Logging level: DEBUG, INFO, WARNING, ERROR
  random_seed:            42                                            # For reproducible splits and model behavior
  subjects:
    - S1
    - S2
    - S3
    - S4
    - S5
    - S6
    - S7
    - S10
    - S11
    - S12
    - S13
    - S16
    - S17
    - S18
    - S19
    - S20
    - S21
    - S22
    - S23
    - S24
    - S26
    - S27


# -------------------------------------------------------------------
# 2. Epoching / preprocessing parameters
# -------------------------------------------------------------------
processing_params:
  epoch_duration_seconds: 30      # window length for segmenting continuous data
  epoch_overlap_seconds:  0       # 0 = non‑overlapping windows
  reject_artifacts:       true    # run EOG/EEG artifact rejection
  baseline_correction:    true
  resample_hz:            128     # set None to keep native sampling
  eeg_reference:          "average"

# -------------------------------------------------------------------
# 3. Feature‑extraction blocks
#    Each block can be toggled independently
# -------------------------------------------------------------------

ear_eog:  # Final selected channels: prefrontal EEG, EOG, and EAR (aligned @ 30 Hz)
  - EEG-E1                 # Prefrontal EEG electrode
#  - EEG-E2                 # Prefrontal EEG electrode
  # - EEG-E3               # Prefrontal EEG electrode (temporarily excluded)
#  - EEG-E8                 # Prefrontal EEG electrode
#  - EEG-E9                 # Prefrontal EEG electrode
  # - EEG-E10              # Prefrontal EEG electrode (temporarily excluded)
  - EOG-EEG-eog_vert_right # Vertical EOG (right eye)
#  - EOG-EEG-eog_vert_left  # Vertical EOG (left eye)
#  - EOG-EEG-eog_hor_right  # Horizontal EOG (right side)
  # - EOG-EEG-eog_hor_left # Horizontal EOG (left side) (temporarily excluded)
#  - EAR-left_ear           # EAR signal - left ear
#  - EAR-right_ear          # EAR signal - right ear
  - EAR-avg_ear            # EAR signal - average of left & right ears


feature_extraction:

  ear:                    # Eye Aspect Ratio from facial landmarks
    enabled: true
    detector: "dlib"            # or "mediapipe"
    smoothing_seconds: 1.0
    stats: ["mean", "std", "min", "max", "trend"]

  eog:                    # Electro‑oculography time‑domain features
    enabled: true
    bandpass_hz: [0.05, 15]
    stats: ["rms", "var", "zcross", "peak_freq"]

  eeg_psd:                # EEG power‑spectral‑density features
    enabled: true
    method: "welch"
    fmin_hz: 0.5
    fmax_hz: 40
    n_fft: 256
    bands:                # canonical frequency bands
      delta: [0.5, 4]
      theta: [4, 8]
      alpha: [8, 12]
      beta:  [12, 30]
      gamma: [30, 40]
    stats: ["abs_power", "rel_power"]

  eeg_mne_features:
    freq_bands:
      delta: [0.5, 4.5]
      theta: [4.5, 8.5]
      alpha: [8.5, 11.5]
      sigma: [11.5, 15.5]
      beta:  [15.5, 30.0]
    selected_features:
      - pow_freq_bands
      - spect_edge_freq
      - energy_freq_bands
      - wavelet_coef_energy
      - kurtosis
      - skewness
      - line_length
      - mean
      - ptp_amp
      - quantile
      - rms
      - std
      - variance
      - spect_slope
      - zero_crossings
      - higuchi_fd
      - hjorth_complexity
      - hjorth_complexity_spect
      - hjorth_mobility
      - hjorth_mobility_spect
      - teager_kaiser_energy
      - phase_lock_val
      - spect_corr
      - time_corr
      - decorr_time
      - katz_fd
      - samp_entropy   # can cause memory issue
      - svd_entropy
      - svd_fisher_info
      - max_cross_corr
      - spect_entropy

# -------------------------------------------------------------------
# 4. Label‑generation experiments
#    (Expanded as requested.)
# -------------------------------------------------------------------
experiments:

  # ── Heuristic, time‑based definitions ────────────────────────────
  - name: "binary_time_based_all"
    strategy: "time_heuristic"
    params:
      rule: "first_vs_last_third"
      labels: ["alert", "fatigue"]
    # No filter means all subjects

  - name: "binary_time_based_male"
    strategy: "time_heuristic"
    subject_filter: { gender: "male" } # Filter by a column in metadata file
    params:
      rule: "first_vs_last_third"
      labels: [ "alert", "fatigue" ]

  - name: "binary_time_based_female"
    strategy: "time_heuristic"
    subject_filter: { gender: "female" } # Filter by a column in metadata file
    params:
      rule: "first_vs_last_third"
      labels: [ "alert", "fatigue" ]

  - name: "binary_time_based_no_glasses"
    strategy: "time_heuristic"
    subject_filter: { glasses: false  } # Assumes a boolean 'glasses' column
    params:
      rule: "first_vs_last_third"
      labels: [ "alert", "fatigue" ]

  # ── EEG PSD + k‑means clustering (primary to denary) ─────────────
  # Note: A primary (1-cluster) experiment is degenerative and not
  # useful for classification, but included for completeness.
  - name: "primary_eeg_knn_all"
    strategy: "eeg_psd_knn"
    params:
      n_clusters: 1
      labels: ["undefined_state"]
  - name: "primary_eeg_knn_male"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "male" }
    params:
      n_clusters: 1
      labels: ["undefined_state"]
  - name: "primary_eeg_knn_female"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "female" }
    params:
      n_clusters: 1
      labels: ["undefined_state"]
  - name: "primary_eeg_knn_no_glasses"
    strategy: "eeg_psd_knn"
    subject_filter: { glasses: false }
    params:
      n_clusters: 1
      labels: ["undefined_state"]

  # ── EEG PSD + k‑means clustering (Secondary, n=2) ────────────────
  - name: "secondary_eeg_knn_all"
    strategy: "eeg_psd_knn"
    params:
      n_clusters: 2
      labels: ["alert", "fatigue"]
  - name: "secondary_eeg_knn_male"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "male" }
    params:
      n_clusters: 2
      labels: ["alert", "fatigue"]
  - name: "secondary_eeg_knn_female"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "female" }
    params:
      n_clusters: 2
      labels: ["alert", "fatigue"]
  - name: "secondary_eeg_knn_no_glasses"
    strategy: "eeg_psd_knn"
    subject_filter: { glasses: false }
    params:
      n_clusters: 2
      labels: ["alert", "fatigue"]

  # ── EEG PSD + k‑means clustering (Tertiary, n=3) ─────────────────
  - name: "tertiary_eeg_knn_all"
    strategy: "eeg_psd_knn"
    params:
      n_clusters: 3
      labels: ["alert", "mild", "fatigue"]
  - name: "tertiary_eeg_knn_male"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "male" }
    params:
      n_clusters: 3
      labels: ["alert", "mild", "fatigue"]
  - name: "tertiary_eeg_knn_female"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "female" }
    params:
      n_clusters: 3
      labels: ["alert", "mild", "fatigue"]
  - name: "tertiary_eeg_knn_no_glasses"
    strategy: "eeg_psd_knn"
    subject_filter: { glasses: false }
    params:
      n_clusters: 3
      labels: ["alert", "mild", "fatigue"]

  # ── EEG PSD + k‑means clustering (Quaternary, n=4) ───────────────
  - name: "quaternary_eeg_knn_all"
    strategy: "eeg_psd_knn"
    params:
      n_clusters: 4
      labels: ["alert", "mild", "moderate", "fatigue"]
  - name: "quaternary_eeg_knn_male"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "male" }
    params:
      n_clusters: 4
      labels: ["alert", "mild", "moderate", "fatigue"]
  - name: "quaternary_eeg_knn_female"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "female" }
    params:
      n_clusters: 4
      labels: ["alert", "mild", "moderate", "fatigue"]
  - name: "quaternary_eeg_knn_no_glasses"
    strategy: "eeg_psd_knn"
    subject_filter: { glasses: false }
    params:
      n_clusters: 4
      labels: ["alert", "mild", "moderate", "fatigue"]

  # ── EEG PSD + k‑means clustering (Quinary, n=5) ──────────────────
  - name: "quinary_eeg_knn_all"
    strategy: "eeg_psd_knn"
    params:
      n_clusters: 5
      labels: ["alert", "mild", "moderate", "severe", "fatigue"]
  - name: "quinary_eeg_knn_male"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "male" }
    params:
      n_clusters: 5
      labels: ["alert", "mild", "moderate", "severe", "fatigue"]
  - name: "quinary_eeg_knn_female"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "female" }
    params:
      n_clusters: 5
      labels: ["alert", "mild", "moderate", "severe", "fatigue"]
  - name: "quinary_eeg_knn_no_glasses"
    strategy: "eeg_psd_knn"
    subject_filter: { glasses: false }
    params:
      n_clusters: 5
      labels: ["alert", "mild", "moderate", "severe", "fatigue"]

  # ── EEG PSD + k‑means clustering (Senary, n=6) ───────────────────
  - name: "senary_eeg_knn_all"
    strategy: "eeg_psd_knn"
    params:
      n_clusters: 6
      labels: ["alert", "wakeful", "mild", "moderate", "severe", "fatigue"]
  - name: "senary_eeg_knn_male"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "male" }
    params:
      n_clusters: 6
      labels: ["alert", "wakeful", "mild", "moderate", "severe", "fatigue"]
  - name: "senary_eeg_knn_female"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "female" }
    params:
      n_clusters: 6
      labels: ["alert", "wakeful", "mild", "moderate", "severe", "fatigue"]
  - name: "senary_eeg_knn_no_glasses"
    strategy: "eeg_psd_knn"
    subject_filter: { glasses: false }
    params:
      n_clusters: 6
      labels: ["alert", "wakeful", "mild", "moderate", "severe", "fatigue"]

  # ── EEG PSD + k‑means clustering (Septenary, n=7) ────────────────
  - name: "septenary_eeg_knn_all"
    strategy: "eeg_psd_knn"
    params:
      n_clusters: 7
      labels: ["alert", "wakeful", "drowsy_1", "drowsy_2", "moderate", "severe", "fatigue"]
  - name: "septenary_eeg_knn_male"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "male" }
    params:
      n_clusters: 7
      labels: ["alert", "wakeful", "drowsy_1", "drowsy_2", "moderate", "severe", "fatigue"]
  - name: "septenary_eeg_knn_female"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "female" }
    params:
      n_clusters: 7
      labels: ["alert", "wakeful", "drowsy_1", "drowsy_2", "moderate", "severe", "fatigue"]
  - name: "septenary_eeg_knn_no_glasses"
    strategy: "eeg_psd_knn"
    subject_filter: { glasses: false }
    params:
      n_clusters: 7
      labels: ["alert", "wakeful", "drowsy_1", "drowsy_2", "moderate", "severe", "fatigue"]

  # ── EEG PSD + k‑means clustering (Octonary, n=8) ─────────────────
  - name: "octonary_eeg_knn_all"
    strategy: "eeg_psd_knn"
    params:
      n_clusters: 8
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8"]
  - name: "octonary_eeg_knn_male"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "male" }
    params:
      n_clusters: 8
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8"]
  - name: "octonary_eeg_knn_female"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "female" }
    params:
      n_clusters: 8
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8"]
  - name: "octonary_eeg_knn_no_glasses"
    strategy: "eeg_psd_knn"
    subject_filter: { glasses: false }
    params:
      n_clusters: 8
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8"]

  # ── EEG PSD + k‑means clustering (Nonary, n=9) ───────────────────
  - name: "nonary_eeg_knn_all"
    strategy: "eeg_psd_knn"
    params:
      n_clusters: 9
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8", "state_9"]
  - name: "nonary_eeg_knn_male"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "male" }
    params:
      n_clusters: 9
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8", "state_9"]
  - name: "nonary_eeg_knn_female"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "female" }
    params:
      n_clusters: 9
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8", "state_9"]
  - name: "nonary_eeg_knn_no_glasses"
    strategy: "eeg_psd_knn"
    subject_filter: { glasses: false }
    params:
      n_clusters: 9
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8", "state_9"]

  # ── EEG PSD + k‑means clustering (Denary, n=10) ──────────────────
  - name: "denary_eeg_knn_all"
    strategy: "eeg_psd_knn"
    params:
      n_clusters: 10
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8", "state_9", "state_10"]
  - name: "denary_eeg_knn_male"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "male" }
    params:
      n_clusters: 10
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8", "state_9", "state_10"]
  - name: "denary_eeg_knn_female"
    strategy: "eeg_psd_knn"
    subject_filter: { gender: "female" }
    params:
      n_clusters: 10
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8", "state_9", "state_10"]
  - name: "denary_eeg_knn_no_glasses"
    strategy: "eeg_psd_knn"
    subject_filter: { glasses: false }
    params:
      n_clusters: 10
      labels: ["state_1", "state_2", "state_3", "state_4", "state_5", "state_6", "state_7", "state_8", "state_9", "state_10"]


# -------------------------------------------------------------------
# 5. Statistics & correlation analysis
# -------------------------------------------------------------------
statistics:
  between_label_tests:
    - test: "anova"
      metrics: ["EAR_mean", "EAR_std", "EEG_theta_rel_power"]
    - test: "kruskal"
      metrics: ["EOG_rms", "EAR_trend"]
  correlation_analysis:
    method: "pearson"           # or "spearman"
    pairs:
      - ["EAR_mean",  "EEG_alpha_abs_power"]
      - ["EAR_mean",  "EOG_rms"]
      - ["EAR_trend", "EEG_theta_rel_power"]

# -------------------------------------------------------------------
# 6. Modelling & evaluation
# -------------------------------------------------------------------
modeling:
  cross_validation:
    n_splits: 5
    stratified: true
    shuffle: true
  classifiers:
    - name: "random_forest"
      params:
        n_estimators: 200
        max_depth: null
    - name: "svm_rbf"
      params:
        C: 1.0
        gamma: "scale"
    - name: "xgboost"
      params:
        n_estimators: 300
        learning_rate: 0.05
  evaluation_metrics: ["accuracy", "f1", "roc_auc", "precision", "recall"]
  save_confusion_matrices: true
  save_roc_curves:        true
  export_trained_models:  true

# -------------------------------------------------------------------
# 7. Reproducible report generation
# -------------------------------------------------------------------
reporting:
  notebook_template: "templates/report.ipynb"
  auto_open: false
  generate_html: true